{% extends 'base.html' %}

{% block content %}
<div class="assessment-details">
  <h2>{{ assessment.name }}</h2>
  <p>{{ assessment.description }}</p>
  <p>Status: <span class="assessment-status">{{ assessment.status }}</span></p>

  <div class="assessment-actions">
    {% if can_edit %}
    <a href="{% url 'edit_assessment' assessment.pk %}" class="btn btn-primary">Edit Assessment</a>
    {% endif %}
    {% if can_submit %}
    <a href="{% url 'submit_assessment' assessment.pk %}" class="btn btn-success">Submit Assessment</a>
    {% endif %}
  </div>
</div>

<div class="risk-landscape">
  <h3>Risk Landscape:</h3>
  <div id="chart"></div>
</div>

<div class="assessment-questions">
  <h3>Questions:</h3>
  <ul>
    {% for question in questions %}
    <li>
      <h4>{{ question.question_text }}</h4>
      {% if responses %}
      <ul class="question-responses">
        {% for response in responses %}
        {% if response.assessment_question == question %}
        <li>{{ response.response_text }}</li>
        {% endif %}
        {% endfor %}
      </ul>
      {% else %}
      <p>No responses available.</p>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
  <a href="{% url 'answer_questions' assessment.pk %}" class="btn btn-primary">Answer Questions</a>
</div>

{% block extra_js %}
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<script>
  // Fetch data from the risk_landscape_data endpoint
  fetch("{% url 'risk_landscape_data' %}")
    .then(response => response.json())
    .then(data => {
      // Dimensions and configs
      const width = 928;
      const height = 600;
      const format = d3.format(",.0f");
      const nodeAlign = "justify";
      const linkColor = "source-target";

      // Create SVG container
      const svg = d3.select("#chart")
        .append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("viewBox", [0, 0, width, height])
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("style", "font: 10px sans-serif;");

      // Configure Sankey generator
      const sankey = d3.sankey()
        .nodeId(d => d.name)
        .nodeAlign(d3[`sankey${nodeAlign[0].toUpperCase()}${nodeAlign.slice(1)}`])
        .nodeWidth(15)
        .nodePadding(10)
        .extent([[1, 5], [width - 1, height - 5]]);

      // Apply data to Sankey generator
      const { nodes, links } = sankey({
        nodes: data.nodes.map(d => Object.assign({}, d)),
        links: data.links.map(d => Object.assign({}, d))
      });

      // Define color scale
      const color = d3.scaleOrdinal(d3.schemeCategory10);

      // Create node rectangles
      const rect = svg.append("g")
        .attr("stroke", "#000")
        .selectAll("rect")
        .data(nodes)
        .join("rect")
        .attr("x", d => d.x0)
        .attr("y", d => d.y0)
        .attr("height", d => d.y1 - d.y0)
        .attr("width", d => d.x1 - d.x0)
        .attr("fill", d => color(d.name));

      // Add node titles
      rect.append("title")
        .text(d => `${d.name}\n${format(d.value)}`);

      // Create link paths
      const link = svg.append("g")
        .attr("fill", "none")
        .attr("stroke-opacity", 0.5)
        .selectAll("g")
        .data(links)
        .join("g")
        .style("mix-blend-mode", "multiply");

      // Create link gradients
      const gradient = link.append("linearGradient")
        .attr("id", (d, i) => `link-gradient-${i}`)
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", d => d.source.x1)
        .attr("x2", d => d.target.x0);

      gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", d => color(d.source.name));

      gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", d => color(d.target.name));

      link.append("path")
        .attr("d", d3.sankeyLinkHorizontal())
        .attr("stroke", (d, i) => `url(#link-gradient-${i})`)
        .attr("stroke-width", d => Math.max(1, d.width));

      // Add link titles
      link.append("title")
        .text(d => `${d.source.name} â†’ ${d.target.name}\n${format(d.value)}`);

      // Add node labels
      svg.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
        .attr("y", d => (d.y1 + d.y0) / 2)
        .attr("dy", "0.35em")
        .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
        .text(d => d.name);

    })
    .catch(error => {
      console.error("Error fetching risk landscape data:", error);
    });
</script>
{% endblock %}
{% endblock %}